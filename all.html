<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <meta name="description" content="A curated selection down jackets, jackets, outerwear, and hoodies. Lightweight, warm, windproof, and water-resistant designs for commuting, outdoor activities, and daily wear. Worldwide shipping available.">
  <title>Newhappybuy - All</title>

  <link rel="stylesheet" href="./style/index.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
  <div id="app">
    <!-- 导航 -->
    <nav-component></nav-component>

    <!-- 分类标题 -->
    <div class="category-header" v-if="currentCategoryName">
      <h1 class="category-title-main">{{ currentCategoryName }}</h1>
    </div>

    <!-- 品牌筛选 -->
    <div class="brands-container" v-if="brands.length > 0">
      <div class="brands-list">
        <div
          v-for="brand in brands"
          :key="brand.id"
          class="brand-capsule"
          :class="{ active: selectedBrandId === brand.id }"
          @click="onBrandClick(brand)"
        >{{ brand.name }}</div>
      </div>
    </div>

    <!-- 商品列表组件 -->
    <category-section-component
      :category-data="categorySection"
    ></category-section-component>

    <!-- 分页按钮 -->
    <div class="pagination-buttons" v-if="!categorySection.loading">
      <button v-if="hasMore" @click="loadCategoryProducts" class="fancy-button">Load More</button>
      <div v-else class="end-message">All products loaded</div>
    </div>

    <social-component></social-component>
  </div>

  <!-- 样式 -->
  <style>
    /* 品牌模块样式 */
    .brands-container {
      padding: 20px 0;
      margin: 0 auto;
      max-width: 1200px;
    }

    .brands-list {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      justify-content: center;
      align-items: center;
    }

    .brand-capsule {
      padding: 4px 10px;
      border: 2px solid #e0e0e0;
      border-radius: 25px;
      background: white;
      cursor: pointer;
      font-size: 12px;
      font-weight: 500;
      color: #666;
    }

    .brand-capsule.active {
      background: #1a1a1a;
      border-color: #1a1a1a;
      color: white;
    }

    /* 分页按钮样式 */
    .pagination-buttons {
      text-align: center;
      margin: 30px 0;
    }

    .fancy-button {
      padding: 12px 30px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 25px;
      cursor: pointer;
      font-size: 16px;
    }

    .fancy-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }

    .end-message {
      text-align: center;
      padding: 20px;
      color: #999;
      font-size: 14px;
    }
  </style>

  <!-- Vue -->
  <script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
  <!-- API -->
  <script src="./api.js"></script>
  <!-- 组件 -->
  <script src="./component/NavComponent.js"></script>
  <script src="./component/CategorySectionComponent.js"></script>
  <script src="./component/SocialComponent.js"></script>

  <script>
    new Vue({
      el: '#app',
      data: {
        currentCategoryId: 0,
        currentCategoryName: '',
        brands: [],
        selectedBrandId: null,
        categorySection: {
          categoryId: 0,
          category: '',
          plist: [],
          loading: false,
          loaded: false,
          error: null
        },
        pagination: {
          page: 1,
          pageSize: 24,
          total: 0,
          totalPages: 0
        }
      },
      computed: {
        hasMore() {
          // 当前页码小于总页数，说明还有更多
          return this.pagination.page < this.pagination.totalPages;
        }
      },
      methods: {
        async loadBrands() {

          console.log("kasihi loadBrands")
          try {
            const res = await categoryApi.getCategoryBrands(this.currentCategoryId);
            if (res.code === 200) this.brands = res.data.brands || [];
          } catch (e) {
            console.error(e);
            this.brands = [];
          }
        },
        async loadCategoryProducts() {

          console.log("kasihi loadCategoryProducts")

          
          const sec = this.categorySection;
          if (sec.loading) return;
          sec.loading = true;

          try {
            const res = await productApi.getProductList({
              page: this.pagination.page,
              pageSize: this.pagination.pageSize,
              category_id: this.currentCategoryId,
              brand_id: this.selectedBrandId
            });

            if (res.code === 200 && res.data) {
              const list = res.data.list || [];
              if (this.pagination.page === 1) sec.plist = list;
              else sec.plist = sec.plist.concat(list);

              this.pagination.total = res.data.total || 0;
              this.pagination.totalPages = res.data.total_pages || 0;
              
              // 重要：设置下一页页码
              this.pagination.page = (res.data.page || this.pagination.page) + 1;
              sec.loaded = true;
            } else {
              sec.error = res.msg || 'Failed to load products';
            }
          } catch (e) {
            sec.error = 'Network error';
          } finally {
            sec.loading = false;
          }
        },
        onBrandClick(brand) {
          this.selectedBrandId = this.selectedBrandId === brand.id ? null : brand.id;
          this.pagination.page = 1;
          this.loadCategoryProducts();
        },
        initFromUrl() {
          console.log( "search" ,  location.search)
          const p = new URLSearchParams(location.search);
          console.log( "pppp" , p )
          console.log( "ppp" ,  p.get('categoryId') )
          this.currentCategoryId = parseInt(p.get('categoryId')) || 0;
          console.log("currentCategoryId")
          console.log(this.currentCategoryId)
          this.currentCategoryName = p.get('categoryName') || '';
          this.categorySection.categoryId = this.currentCategoryId;
          this.categorySection.category = this.currentCategoryName;
        }
      },
      mounted() {
        this.initFromUrl();
        if (this.currentCategoryId) {
          console.log("分类id拿到了")
          this.loadBrands();
          this.loadCategoryProducts();
        }
      }
    });
  </script>
  <script>
  window.va = window.va || function () { (window.vaq = window.vaq || []).push(arguments); };
  window.si = window.si || function () { (window.siq = window.siq || []).push(arguments); };
</script>
<script defer src="/_vercel/insights/script.js"></script>
<script defer src="/_vercel/speed-insights/script.js"></script>
</body>

</html>




